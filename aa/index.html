<!DOCTYPE html>
<html>
	<head>
		<meta charset='UTF-8'>
		<style>

canvas{
	display: none;
}

#output{
	font-size: 1em; 
	line-height: 1em;
	letter-spacing: 0;
}


		</style>
	</head>
	<body>
		<select id='imagepath'>
			<optgroup label='実写'>
				<option value='./abe.png'>阿部寛</option>
				<option value='./majima.jpg'>満島ひかり</option>
				<option value='./ramen.jpg'>ラーメン二郎</option>
			</optgroup>
			<optgroup label='アニメ・イラスト'>
				<option value='./yunocchi.png'>ゆのっち</option>
				<option value='./ikr7.png'>ikr7</option>
			</optgroup>
		</select>
		<input type='text' value='　▁▂▄▅▇█'>
		<input type='button' value='適用する'><br>
		<canvas></canvas>
		<div id='output'></div>
		<script>

document.querySelectorAll('input').item(1).addEventListener('click', app, false);
app();

function app(){
	var cvs = document.querySelector('canvas');
	cvs.width = 512;
	cvs.height = 512;

	var dotSize = 8;

	var ctx = cvs.getContext('2d');
	var chars = document.querySelector('input').value.split('');
	var o = document.querySelector('#output');
	o.innerHTML = '';

	var image = new Image();
	image.src = document.querySelector('select').value;
	image.addEventListener('load', function(){
		
		ctx.fillStyle = '#FFFFFF';
		ctx.fillRect(0, 0, cvs.width, cvs.height);
		
		ctx.drawImage(image, 0, 0, cvs.width, cvs.height);	
		ctx.fillStyle = '#F00';

		var c = 0;

		for(var i = 0; i < ctx.canvas.height; i += dotSize){
			for(var j = 0; j < ctx.canvas.width; j += dotSize){

				//デバッグ用
				//ctx.fillText(c, j, i+10);
				//ctx.strokeRect(j, i, dotSize, dotSize);

				var chunk = ctx.getImageData(j, i, dotSize, dotSize);

				var r = 0, g = 0, b = 0;

				for(var k = 0; k < chunk.data.length; k += 4){
					r += chunk.data[k + 0];
					g += chunk.data[k + 1];
					b += chunk.data[k + 2];
				}

				var darkness = 1 - (r + g + b) / (255 * 3 * dotSize * dotSize);

				o.innerHTML += chars[darkness * chars.length | 0];
			}
			o.innerHTML += '<br>'
		};

	}, false);
}

		</script>
	</body>
</html>